Linux поддерживает отдельное виртуальное адресное пространство для каждого процесса.

В Linux виртуальное адресное пространство делится на 2 основные части, которые в свою очередь разделены на различные сегменты виртуальной памяти.

![[Linux vm.png|500]]


## Kernel virtual Memory

данная часть виртуального адресного пространства используется ядром операционной системы

в этой области содержится код и структуры данных, небходимые для работы ядра

Код ядра является общим для всех процессов в системе

...

---

## Process virtual Memory

Каждый процесс имеет своё собственное виртуальное адресное пространство, которое изолировано от других процессов.

Виртуальное пространство процесса представляет из себя коллекцию *сегментов*

- Сегмент - это непрерывный фрагмент виртуальной памяти, страницы которой связаны между собой по какому-то признаку
	- Каждая существующая виртуальная страница обязательно содержится в каком-то из сегментов.


![[vm_segment_structs list.png|750]]

- Ядро ОС поддерживает отдельную структуру данных `task_struct` для каждого процесса в системе.
	- Поля данной структуры содержат или указывают на всю информацию, которая необходима ядру для выполнения процесса.
		
- Одно из полей `task_struct` указывает на структуру `mm_struct`, которая характеризует текущее состояние виртуальной памяти.
	- `mm_struct` содержит поле `pgd`, которое указывает на начало таблицы страниц первого уровня иерархии (page global directory).
	- также `mm_struct` содержит поле `mmap`, которое указывает на список структур `vm_area_structs`, каждая из которых характеризует соответсвующий сегмент виртуального пространства (указатели на начало и конец, флаги, ...)


---

## Page fault exception handling && segfault :)

Когда блок управления памятью (Memory Management Unit, MMU) вызывает page fault при попытке преобразовать некоторый виртуальный адрес **A**, это приводит к передаче управления обработчику ошибок, который является частью ядра операционной системы.

Обработчик выполняет следующие шаги:

- **Проверка виртуального адреса**
	- Обработчик ошибок проверяет, находится ли виртуальный адрес A внутри сегмента, определенного какой-либо структурой сегмента (segment struct).
	- Для этого он просматривает список структур сегментов, сравнивая адресс **A** с полями `vm_start` и `vm_end` каждой структуры.
		- Если адрес **A** не лежит внутри какого-либо сегмента, это означает, что обращение к памяти не является законным. 
		- **В таком случае обработчик вызывает ошибку сегментации (segmentation fault), что приводит к завершению процесса.**

- **Проверка прав доступа**
	- Обработчик проверяет, имеет ли процесс разрешение на выполнение запрошенной операции (чтение, запись или выполнение)
	
	- Если попытка доступа не является законной, обработчик вызывает защитную ошибку (protection exception), что также приводит к завершению процесса.

- **Обработка законной ошибки страницы**
	- Если ядро определило, что ошибка страницы произошла из-за законной операции с действительным виртуальным адресом, оно начинает непосредственную обработку ошибки ([[Virtual memory (VM)]])

![[page fault linux.png]]

---
